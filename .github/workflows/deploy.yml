name: Deploy OpenNext as Cloudflare Workers

on:
  push:
    branches:
      - main
      - dev
  workflow_dispatch:

jobs:
  download-build:
    runs-on: ubuntu-latest
    name: Download OpenNext Build
    outputs:
      build-path: ${{ steps.set-path.outputs.build-path }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download OpenNext artifact
        uses: actions/download-artifact@v4
        with:
          name: open-next-build
          path: .open-next

      - name: Set build path output
        id: set-path
        run: echo "build-path=.open-next" >> $GITHUB_OUTPUT

  deploy-worker:
    runs-on: ubuntu-latest
    name: Deploy OpenNext Worker
    needs: download-build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy with Wrangler
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: ${{ needs.download-build.outputs.build-path }}
          packageManager: bun
